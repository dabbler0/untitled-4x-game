import { Board, Cell, Globe } from './Model';
import { Coordinate, plus } from './Coordinate';

const buildingColorMap: Record<string, string> = {
  'house': '#966F33',
  'farm': '#f5deb3',
  'storehouse': 'gray',
  'palace': 'gold',
  'encampment': 'white',
  'expeditionBase': 'green',
  'mine': 'brown',
  'fishery': 'brown',
  'loggery': '#003C00',
  'qanat': 'cyan',
  'irrigatedFarm': 'wheat',
  'gatheringHut': '#003C00',
  'tradingPost': 'brown',
  'haven': 'white',
};
const buildingIconMap: Record<string, string> = {
  'encampment': 'M361.155 91.245l-18 .193.42 38.98c-45.773 13.285-108.533 19.738-166.474 23.573 35.097 96.284 99.357 173.77 157.845 257.13 20.718-19.655 51.11-31.983 83.46-36.01-20.8-18.109-36.634-27.966-58.833-70.438 31.27 37.085 52.579 48.467 77.623 62.006 3.263-13.094 8.938-24.638 18.721-32.674 8.667-7.12 20.026-10.654 33.53-10.344-46.874-59.763-101.67-117.054-127.83-189.435l-.462-42.98zM163.25 102.92l-17.998.244s.25 18.34.56 36.97c.156 9.316.325 18.703.489 25.929.06 2.636.117 4.58.174 6.542-34.378 83.733-69.154 160.993-123.92 233.442 33.635-1.387 66.326-1.203 98.552-.041 22.263-62.617 23.346-134.855 35.627-202.006 11.417 68.562 10.566 139.445 33.483 205.83 42.962 3.082 85.69 7.198 129.35 10.926-55.67-79.151-118.213-155.037-155.118-249.365-.05-1.782-.1-3.396-.152-5.737-.162-7.156-.333-16.523-.488-25.82-.31-18.594-.559-36.914-.559-36.914z', // GiCampingTent icon
  'house': 'M256 19.27L25.637 249.638 19.27 256 32 268.73l6.363-6.367L256 44.727l217.637 217.636L480 268.73 492.73 256l-6.367-6.363zM96 48v107.273l64-64.002V48zm160 20.727l-192 192V486h64V320h96v166h224V260.727zM288 320h96v80h-96z', // GiHouse icon
  'farm': 'M98.344 16.688C79.692 43.785 68.498 69.01 65.5 89.56l23.938 39.157 28.624-33.47c.868-21.213-5.49-48.677-19.718-78.563zM472.5 19.625C444.04 36.055 423.112 54 411.562 71.25l4.75 45.688L456.563 99c9.89-18.777 15.938-46.29 15.938-79.375zm-91.75 27.28c-10.153 21.036-16.8 40.84-20.156 58.314l18.375 57.686 19.78-34.25-6.5-62.22h.03c-3.422-6.392-7.252-12.906-11.53-19.53zM27.25 80.782c-.125 23.364 2.393 44.102 6.875 61.314L75.5 186.25l3.125-39.406L46 93.47l.03-.032c-5.83-4.287-12.08-8.52-18.78-12.657zm132.844 10.532c-8.415 3.504-16.29 7.213-23.594 11.094l-39.25 45.97-3.094 39.374 50.438-39.094c6.712-15.904 12.09-35.263 15.5-57.344zm177.22 21.626c-24.024 58.09-16.16 97.86 7.873 108.5l21.157-36.625-19.594-61.438c-2.973-3.46-6.108-6.943-9.438-10.438zm146.03.218c-4.55-.028-8.97.084-13.28.28L414.935 138l-19.78 34.28 62.343-13.655c12.897-11.47 26.09-26.626 38.656-45.094-4.358-.216-8.64-.348-12.812-.374zm-226.094 8.72c-23.24 23.238-38.832 46.003-45.53 65.655l16.436 42.907 34.22-27.75c4.695-20.704 3.436-48.856-5.126-80.812zM16.406 159.06c3.28 62.77 27.482 95.31 53.75 94.594l3.344-42.22-44.063-47c-4.175-1.844-8.515-3.647-13.03-5.374zm143.22 11.375c-6.457 1.354-12.63 2.896-18.5 4.563l-48.97 37.938-3.312 41.75c26.492 7.51 57.16-20.567 70.78-84.25zm16.06 1.563c-4.36 22.935-5.65 43.762-4.374 61.5l32.688 51 10.22-38.188-22.407-58.437h.03c-4.952-5.28-10.318-10.592-16.155-15.875zm267.408 8.938l-60.563 13.218-20.936 36.25c20.682 18.195 60.438 6.035 100.125-45.625-6.413-1.552-12.62-2.823-18.626-3.843zm-138.688 25.53c-8.912 1.92-17.304 4.16-25.187 6.657l-46.97 38.03-10.22 38.19 56.69-29.283c9.493-14.424 18.323-32.49 25.686-53.593zm155.125 25.063c-25.85 20.324-44.046 41.06-53.03 59.782l11.22 44.532 37.28-23.47c7.126-19.99 9.236-48.088 4.53-80.843zm-123.342 8.595c-34.435 77.573-59.394 159.06-62.97 253.03h18.72c3.558-90.792 27.573-169.428 61.312-245.436l-17.063-7.595zm-185.375 6.906c-8.173 62.347 9.714 98.713 35.687 102.75l10.97-40.874-34.814-54.25c-3.77-2.57-7.713-5.105-11.844-7.625zm221.75 24.532c-7.053 22.243-10.817 42.77-11.657 60.532l26.406 54.594L402 349.967l-15.28-60.687h.06c-4.3-5.848-9.033-11.76-14.217-17.717zm-302.47 1.532c-8.664 74.584-8.13 147.835 12.188 220.062h19.44c-20.877-70.772-21.764-143.02-13.064-217.906l-18.562-2.156zm219.47 11.094c-6.613.16-12.953.54-19.032 1.125L215.5 313.78l-10.844 40.408c24.69 12.23 59.938-9.82 84.906-70zm206.718 36.937c-9.072.844-17.664 2.052-25.78 3.594l-51.156 32.217-14.688 36.657 59.75-22.313c11.14-13.193 22.055-30.075 31.875-50.155zm-157.31 22c-15.528 60.938-2.096 99.19 23.217 106.28l15.72-39.28-28.094-58.03c-3.43-3-7.053-5.985-10.844-8.97zM183.25 368.72c-12.674 41.233-22.26 82.547-26.844 124.436h18.813c4.507-39.722 13.69-79.23 25.905-118.97l-17.875-5.467zm270 26.655l-58 21.688-15.563 38.875c23.056 15.098 60.673-2.606 92.625-59.407-6.594-.627-12.95-1.003-19.062-1.155zM356.5 469.03c-1.874 7.713-3.185 15.757-3.656 24.126h18.687c.45-6.686 1.55-13.206 3.126-19.687l-18.156-4.44z', // GiWheat icon
  'irrigatedFarm': 'M167.6 26.93s-6.1 50.65 6.7 70.42c7 10.75 21.2 22.55 33.5 18.85 9.4-2.9 14.4-16.56 13.2-26.29-3.3-27.33-53.4-62.98-53.4-62.98zm150.1.32s10.7 69.41 33.7 93.05c8.7 8.9 23.9 19.4 34.8 13.5 8.4-4.6 8.5-19 5.9-28.2-9.8-34.67-74.4-78.35-74.4-78.35zM24.56 42.28S35.02 115 57.61 141.6c7.76 9.1 23.6 20.5 31.84 16.7 6.65-3 8.15-18.9 5.85-28.2-8.75-36.62-70.74-87.82-70.74-87.82zM261.7 110.1s-1.2 61.1 17.1 82.2c7.7 8.7 22.4 16.8 32.9 11.8 9-4.4 11.7-18.9 9.6-28.8-6.2-28.8-59.6-65.2-59.6-65.2zm-115.4 26.6s-7.1 48.7 6.6 66.1c7.4 9.4 22.8 16.5 33.9 11.9 8.8-3.6 14.1-16.4 12.5-25.8-4.2-24.5-53-52.2-53-52.2zm292 84.9c-45.7 18-119.3-5.9-142.4 35.9-8 11.3 2.9 24 7.8 33.5-13 11.1-26.2 23.7-36.9 36.9-19.2-3.3-31.4-7-39.6-12.6l.1-.1c2.9-81.3-95.3-29-147.99-57 6.99 51.9 74.29 49.2 86.49 65 10.7 11.1 30.3 10.2 46 2.9 1.2 1.1 2.5 2.2 3.9 3.2 10.3 7.4 22.9 11.6 39.8 14.8-2.6 4.5-4.8 9-6.5 13.6-3.3 9.2-5 19.7-5.6 30.8-16.7-11.7-50.2-6.4-76.3-21.9 2.7 18.4 39.1 77.6 77.7 57 1.1 9.7 2.6 19.4 4.2 28.6 2.9 16.6 6.4 31.4 9.1 41.8h18.5c-2.6-9.8-6.6-26.3-9.9-44.9-.2-1-.3-2.1-.5-3.1 26.1-5.7 53.9-15.9 71.6-38.6 4.5 1.5 10.3 1.9 17.1.8 29.9-14.7 51.7-37.3 109-25.5-29.5-14.2-66.5-28.1-95-28.4h-2.1c-21 .2-37.1 8.4-41.3 30.3-.6 3.3-.6 6.3-.1 9.1-13.6 19.5-37.2 28.9-61.8 34.4-2.8-24.5-3.1-49.3 2.4-64.2 6.8-18.8 31.4-44.2 54.5-63.5 1.7-1.4 3.3-2.8 5-4.1 6.8 2.8 12.6 6.9 21.6 5.8 42.1-7.1 70.4-49.9 91.2-80.5z', // GiPlantWatering icon
  'storehouse': 'M37.727 25l78 78h280.546l78-78H37.727zM25 37.727v436.546l78-78V115.727l-78-78zm462 0l-78 78v280.546l78 78V37.727zM79.957 40a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zM432 40.793a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zM112 72a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm287.45 0a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm63.42 0a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zM48 73.047a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zM79.395 104a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm352.605.2a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zM121 121v193.273l53.7-53.7L174.065 121H121zm71.064 0l.555 121.654 54.38-54.38V121h-54.936zM265 121v49.273L314.273 121H265zm74.727 0L121 339.727V391h51.273L391 172.273V121h-51.273zM391 197.727l-53.023 53.023V391H391V197.727zm-71.023 71.023L265 323.727V391h54.977V268.75zM247 341.727L197.727 391H247v-49.273zM77.97 392a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm354.03.658a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zM115.727 409l-78 78h436.546l-78-78H115.727zM48 423.752a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm64 .8a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm288 .712a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm64 4.74a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zM432 456a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm-352 2.56a8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8z', // GiWoodenCrate icon
  'expeditionBase': 'M356.688 19.188c-6.83-.032-12.837.64-18.125 1.843-24.178 5.495-36.437 21.983-50.938 41.157-14.5 19.175-31.317 40.993-62.78 47.47C195.08 115.78 154.27 108.253 91.25 78.5c-10.013 44.88-33.406 128.62-60.906 178.656 60.093 28.5 97.245 34.926 121 30.875.01 0 .02.004.03 0 21.59-5.827 34.487-20.094 47.876-43.092 17.014-29.227 32.563-72.198 60.25-123.188l16.406 8.938c-16.69 30.735-28.802 58.617-40 82.937 8.552-6.512 18.633-11.77 31.063-14.594 27.71-6.296 65.053-.495 121.655 24.75-6.932-29.276-1.885-61.913 9.875-92.218 12.686-32.69 33.038-62.907 56.28-84.03-42.595-19.553-73.152-27.554-95.124-28.282-1.01-.033-1.993-.058-2.97-.063zm127.54 14.144c-.858-.025-1.752.062-2.664.266-4.378.977-8.94 4.424-12.084 11.097L289.53 497.31h23.61L490.972 49.368c3.475-10.153-.75-15.86-6.746-16.035z', // GiFlyingFlag icon
  'mine': 'M136.48 27.746c-2.108.024-4.174.152-6.242.272 42.927 23.035 87.233 59.434 121.902 96.57 8.66 9.276 12.358 18.765 16.371 27.44 2.486 5.37 5.173 10.658 9.297 16.37l30.65-26.373c-3.067-5.031-5.213-10.567-6.044-16.386-.919-6.432.09-13.283 3.039-19.48-32.92-24.035-68.653-47.25-102.75-62.026-22.779-9.871-44.547-15.843-64.1-16.371-.714-.02-1.42-.024-2.123-.016zm226.463 99.256c-2.825 0-5.562.505-8.092 1.293l28.91 28.91c.788-2.53 1.293-5.266 1.293-8.092 0-6.485-2.314-12.726-5.85-16.262-3.535-3.535-9.776-5.85-16.261-5.85zm-23.088 11.754l-21.89 18.836c9.951-2.533 20.985.059 28.712 7.787 7.728 7.728 10.32 18.761 7.788 28.713l18.835-21.89zm-14.39 35.78c-3.053 0-6.104 1.189-8.485 3.57-4.762 4.761-4.762 12.208 0 16.97 4.762 4.762 12.21 4.762 16.97 0 4.763-4.762 4.763-12.209 0-16.97-2.38-2.381-5.433-3.57-8.485-3.57zm-27.582.335l-9.846 8.47-5.352 46.03 46.03-5.352 8.468-9.841c-10.923 4.588-24.09 2.467-32.931-6.373-8.842-8.842-10.959-22.01-6.37-32.934zm72.148 28.727l-26.373 30.65c5.712 4.124 11 6.812 16.371 9.297 8.674 4.013 18.163 7.711 27.44 16.37 37.136 34.67 73.534 78.977 96.57 121.903 1.254-21.638-4.803-46.36-16.115-72.465-14.776-34.097-37.992-69.829-62.026-102.75-6.198 2.95-13.049 3.958-19.48 3.04-5.82-.832-11.355-2.978-16.387-6.045zm-103.375 7.79l-28.398 26.588L274.08 273.8l26.588-28.399-38.489 4.477zm-41.545 38.897l-11.686 10.941 37.405 37.405 10.941-11.686zm-24.832 23.252l-90.564 84.797 44.007 44.008 84.797-90.565zM96.566 370.643l-21.91 20.515 46.242 46.242 20.516-21.91zm-28.09 39.79l-5.656 16.971 21.832 21.832 16.97-5.656zm-18.789 29.295l-18.49 9.686a106.156 106.156 0 0 0-2.746 13.676c-.608 4.548-.852 9.29-.469 12.92.383 3.63 1.496 5.735 1.912 6.152.417.417 2.523 1.53 6.153 1.912 3.63.383 8.372.139 12.92-.469a106.155 106.155 0 0 0 13.675-2.746l9.686-18.49z', // GiWarPick icon
  'fishery': 'M453 61.16C382.3 72.25 282.7 104.9 207.3 160c.4.2.8.5 1.2.7 4.8 3.1 8.8 7.3 11.5 12.4 66-47.5 153.2-78.35 219-91.15V401.8h18V73.85c-.3-5.2-3.1-12.04-4-12.69zm-344.9 5.69c-18.66 0-35.13 18.4-35.13 42.85 0 24.5 16.47 42.9 35.13 42.9 18.7 0 35.1-18.4 35.1-42.9 0-24.45-16.4-42.85-35.1-42.85zM79.73 161.2c-16.65 42.2-23.61 86.3-28.4 126.9 24.46-.9 48.24-2.4 70.97-4.5-1.8-14.3-2.9-28.5-3.5-42.7-8-5.9-16.2-12.8-24.39-20.1l11.99-13.4c10.9 9.7 21.5 18.4 30.9 24.5 9.3 6.2 17.6 9.5 21.9 9.8h.1c-.5 0 2.1-.4 5.7-2.8 3.5-2.5 8-6.5 12.6-11.5 9.2-9.9 19.2-23.9 26.7-37.8 1.3-2.4 1.3-4.4.3-6.9-.9-2.5-3.1-5.2-5.9-6.9-2.7-1.8-5.8-2.6-8.4-2.3-2.6.3-5.1 1.3-7.9 5.1l-26.8 35.9-42-44.3c-1.8.3-3.6.4-5.5.4-10.56 0-20.24-3.5-28.37-9.4zM273.3 278.5c-63.1 14.3-154.2 27.4-254.3 28.1v94.2h138.7c53.8-27.5 96.3-79.7 115.6-122.3zM64 416.8c-13.18 0-29.27 4.3-42.85 8.4-1.08.3-2.11.6-3.15 1V445c2.59-.8 5.39-1.7 8.36-2.6 12.92-3.9 28.83-7.6 37.64-7.6 8.81 0 18.29 3.4 28.79 7.4 10.51 4 22.01 8.6 35.21 8.6s24.7-4.6 35.2-8.6c10.5-4 20-7.4 28.8-7.4s18.3 3.4 28.8 7.4 22 8.6 35.2 8.6c13.2 0 24.7-4.6 35.2-8.6 10.5-4 20-7.4 28.8-7.4s18.3 3.4 28.8 7.4 22 8.6 35.2 8.6c13.2 0 24.7-4.6 35.2-8.6 10.5-4 20-7.4 28.8-7.4s24.7 3.7 37.6 7.6c3 .9 5.8 1.8 8.4 2.6v-18.8c-1-.4-2-.7-3.1-1-13.6-4.1-29.7-8.4-42.9-8.4s-24.7 4.6-35.2 8.6c-10.5 4-20 7.4-28.8 7.4s-18.3-3.4-28.8-7.4-22-8.6-35.2-8.6c-13.2 0-24.7 4.6-35.2 8.6-10.5 4-20 7.4-28.8 7.4s-18.3-3.4-28.8-7.4-22-8.6-35.2-8.6c-13.2 0-24.7 4.6-35.2 8.6-10.5 4-20 7.4-28.8 7.4s-18.3-3.4-28.8-7.4-22.02-8.6-35.2-8.6z', // GiBoatFishing icon
  'loggery': 'M353.86 48.45c-10.626-.16-20.45 3.456-29.14 13.253l-.193.217-50.586 50.098.628.703c3.395 3.7 3.106 9.463-.642 12.804-3.748 3.342-9.505 2.97-12.793-.825l-5.985-6.712c-.784 1.096-1.627 2.16-2.544 3.178-5.116 5.68-11.746 9.448-18.688 11.023l5.438 20.302c2.54 8.98-8.582 15.417-15.102 8.738l-41.2 40.803c1.41-.082 2.83-.135 4.26-.135 40.63 0 73.616 33.616 73.616 74.672 0 .803-.036 1.598-.06 2.395l141.94-153.74c8.252-10.316 9.687-20.888 6.985-31.832C407.08 82.4 399.6 71.29 389.653 62.967c-3.085-2.583-6.396-4.885-9.835-6.854L258.56 182.725c-3.418 3.685-9.193 3.856-12.824.38-3.63-3.478-3.71-9.255-.175-12.83l115.932-121.05c-1.843-.34-3.68-.584-5.494-.694-.715-.042-1.428-.07-2.137-.08zM232.31 85.597c-4.224-.048-8.876 1.842-12.583 5.96-6.327 7.024-5.918 16.11-.913 20.62 5.006 4.508 14.088 3.968 20.415-3.057 6.325-7.024 5.917-16.112.91-20.62-1.877-1.69-4.328-2.672-6.992-2.867-.277-.02-.556-.032-.837-.035zm-27.95 63.94c-7.19-.12-13.63 2.222-19.577 8.925l-.19.217-99.734 98.77c10.89.53 20.967 4.222 29.386 10.167 1.406-11.834 5.547-22.84 11.785-32.332l.44-.67 6.39-8.21c1.915-2.138 3.963-4.148 6.11-6.05l70.907-70.224c-1.372-.268-2.734-.453-4.07-.534-.486-.03-.968-.05-1.448-.057zm193.3 14.415c-2.226.018-4.423.188-6.588.52L245.744 321.88c-2.968 3.93-6.313 7.544-9.976 10.806l-5.715 6.19c9.9 2.162 19.137 6.16 27.34 11.628-.004-.254-.02-.505-.02-.76 0-12.38 4.545-23.756 12.03-32.496l-.087-.086 1.358-1.344c1.008-1.09 2.06-2.135 3.16-3.13L381.01 206.545c8.52-9.363 20.055-13.314 30.816-12.662 10.908.66 21.093 5.423 29.33 12.316 8.238 6.892 14.684 16.035 17.278 26.538.788 3.194 1.158 6.54 1.078 9.922 4.62-9.422 4.9-19.095 2.242-28.918-3.484-12.87-12.614-25.674-24.47-34.967v.002c-11.194-8.77-24.658-14.314-37.27-14.79-.79-.028-1.573-.04-2.354-.034zm11.926 47.852c-5.712-.106-10.696 1.69-15.463 7.064l-.193.216-82.07 81.28c22.277 2.517 40.072 20.28 43.12 42.585l82.31-89.153c4.454-5.58 5.124-10.833 3.665-16.742-1.468-5.945-5.675-12.3-11.35-17.05-5.678-4.75-12.668-7.778-18.867-8.153-.387-.024-.77-.04-1.152-.047zm-222.274 8.097c-4.898 0-9.644.647-14.167 1.85 1.964-.262 3.962-.41 5.994-.41 24.715 0 45.067 19.99 45.067 44.566 0 24.576-20.355 44.567-45.068 44.567-24.718 0-45.07-19.992-45.07-44.567 0-2.83.282-5.593.797-8.277-2.044 5.915-3.166 12.284-3.166 18.94 0 31.482 24.873 56.668 55.613 56.668s55.61-25.185 55.61-56.668c0-31.482-24.87-56.668-55.61-56.668zm-8.173 19.44c-15.12 0-27.07 11.857-27.07 26.566 0 14.71 11.945 26.567 27.07 26.567 15.117 0 27.067-11.858 27.067-26.567 0-14.71-11.944-26.566-27.068-26.566zm-3.388 7.357c8.742 0 16.023 7.276 16.023 16.02s-7.285 16.02-16.023 16.02c-8.742 0-16.025-7.275-16.025-16.02 0-8.743 7.287-16.02 16.025-16.02zm-93.61 28.68c-21.25 0-38.427 17.364-38.427 39.2 0 21.835 17.177 39.2 38.426 39.2 21.25 0 38.426-17.364 38.426-39.2 0-3.01-.338-5.933-.957-8.74-1.208-2.858-2.23-5.813-3.08-8.838-6.297-12.877-19.314-21.623-34.39-21.623zm-.36 11.016c15.59 0 27.085 14.1 27.085 29.823 0 15.724-11.498 29.82-27.086 29.82-15.59 0-27.087-14.098-27.087-29.82 0-15.727 11.5-29.824 27.088-29.824zm372.58.325c-6.907-.118-13.068 2.118-18.79 8.567l-.193.22-96.345 95.415c27.285 1.628 49.25 23.576 51.547 50.926l96.64-104.672c5.384-6.735 6.24-13.283 4.48-20.42-.234-.944-.527-1.893-.868-2.844l-63.383 66.342c-3.41 3.703-9.196 3.888-12.837.41-3.64-3.48-3.72-9.267-.175-12.844l65.103-68.144c.345-.37.72-.71 1.122-1.018-.786-.76-1.604-1.497-2.447-2.203-6.715-5.62-14.988-9.227-22.463-9.68-.467-.028-.93-.046-1.39-.054zm-372.9 14.73c-7.59 0-13.74 7.046-13.74 15.738 0 8.69 6.15 15.736 13.74 15.736s13.743-7.045 13.743-15.736c0-8.69-6.152-15.737-13.742-15.737zm224.952 16.6c-17.17 0-31.04 14.004-31.04 31.694 0 17.69 13.87 31.695 31.04 31.695s31.04-14.006 31.04-31.696-13.87-31.693-31.04-31.693zm-2.285 11.155c11.398 0 19.28 10.28 19.28 21.092 0 10.814-7.884 21.09-19.28 21.09-11.4 0-19.282-10.277-19.282-21.09 0-10.814 7.883-21.092 19.28-21.092zm-163.378 5.13l-14.027 15.192c-2.17 2.835-4.59 5.46-7.235 7.838l-3.986 4.317c9.624 5.793 17.842 13.746 24.006 23.185 6.715-14.72 17.602-27.106 31.113-35.588-11.134-2.634-21.307-7.826-29.87-14.946zm72.31 20.704c-34.83 0-63.015 28.553-63.015 64.192 0 35.64 28.186 64.194 63.016 64.194s63.017-28.554 63.017-64.194c0-35.638-28.188-64.193-63.017-64.193zM68.68 370.114C42.442 374.65 22.5 397.775 22.5 425.96c0 14.03 4.95 26.802 13.146 36.66-5.09-7.662-8.066-16.868-8.064-26.725v-.004c-.005-26.31 21.188-47.994 47.29-47.994 26.105 0 47.298 21.684 47.292 47.996.005 20.913-13.386 38.89-31.986 45.393 22.622-5.065 40.05-24.075 43.076-47.908-.792-4.6-1.207-9.324-1.207-14.145 0-2.07.077-4.125.226-6.16-4.7-20.763-20.513-37.028-40.71-42.11-3.065.528-6.21.817-9.422.817-4.64 0-9.146-.586-13.462-1.665zm140.48.643c27.187 0 49.2 22.702 49.2 50.203 0 27.503-22.016 50.204-49.2 50.204-27.187 0-49.2-22.702-49.2-50.203 0-27.5 22.017-50.202 49.2-50.202zm0 17.998c-17.21 0-31.2 14.195-31.2 32.205 0 18.012 13.983 32.206 31.2 32.206 17.212 0 31.2-14.195 31.2-32.205 0-18.01-13.982-32.204-31.2-32.204zm81.856 8.148c1.256 4.498 2.16 9.143 2.642 13.912 3.67-4.432 8.01-8.273 12.852-11.38-.032.002-.062.003-.094.003-5.38 0-10.554-.9-15.4-2.536zm-216.14 8.992c-16.2 0-29.295 13.238-29.29 29.995v.005c-.005 16.756 13.09 29.994 29.29 29.994 16.197 0 29.295-13.24 29.29-29.995v-.004c.005-16.756-13.093-29.994-29.29-29.994zm133.706.256c8.967 0 14.96 7.945 14.96 15.953 0 8.01-5.993 15.952-14.96 15.952-8.966 0-14.96-7.943-14.96-15.952 0-8.008 5.994-15.953 14.96-15.953zm127.203 2.664c-20.47 0-37.013 16.723-37.013 37.766 0 21.042 16.544 37.766 37.013 37.766 20.47 0 37.012-16.723 37.012-37.766 0-21.042-16.543-37.766-37.012-37.766zM71.833 422.39c8.965 0 14.958 7.943 14.958 15.952 0 8.01-5.992 15.953-14.958 15.953-8.966 0-14.96-7.944-14.96-15.953 0-8.01 5.994-15.953 14.96-15.953zm267.923 1.423c14.727 0 26.683 12.307 26.683 27.037 0 14.73-11.958 27.037-26.684 27.037-14.728 0-26.682-12.308-26.682-27.037 0-14.73 11.955-27.038 26.682-27.038zm0 18c-4.802 0-8.682 3.845-8.682 9.037s3.877 9.037 8.682 9.037c4.8 0 8.683-3.846 8.683-9.037 0-5.193-3.88-9.038-8.684-9.038z', // GiWoodPile icon
  'gatheringHut': 'M365.1 30.76c-16.7 3.83-35.9 36.61-47.6 50.9 8.2 3.7 17.3 3.8 26.9 3.6 4.7-7.83 49.9-54.37 20.7-54.5zm-264.3 64.9c12.1 7.44 28.8 8.84 40.6 8.94 27.2.2 62.9-6.14 99.9-17.24l8.6 15.34c-20.7 18.6-25.7 33.6-25.7 44-.1 10.4 5.9 17.6 7.3 18.6 10.5 7.7 24.9 7.2 42.7-.1 17.9-7.2 37.7-21.1 55.5-36.7l9.2-8.2 5 11.3c12.8 29.1 25.3 55.5 40.5 72.6 13 14.7 27.1 22.9 47.7 22.2-8.9-27.4-14-47.6-21.5-64.2-8.5-18.8-20-34.4-45.9-55.9-3.2-2.6-9.5-3.1-19.4-3-26.5-.2-45.2-5.6-63.4-25.14-5.8-6.3-10.2-11.9-20.7-19.8-57.3 7.28-114 23.84-160.4 37.3zm116.8 16.74c-19.3 4.7-37.9 7.8-55 9.3-1.3 6.9-8 17.9-14 16.7-4.4-1.2-6.5-8-5.2-15.8-9.8-.2-20.1-.8-28.5-2.5-15.26 15.7-19.51 38-23.31 56.7 8.1-1.4 9.11 12.8 7.76 18.4-2.34 8.7-8.08 14.7-12.99 13.8-5.49 44-5.81 93.1-6.06 138.7-.29 54.3-4.75 99.6 27 129.2 85.7 24 196.2-55.3 262-122.3-2.4.8-4.5.6-6.1-.4-4.3-2.9-3.6-11.4 1.5-19 4.1-4.7 10.8-12.4 17-8.8 3.2 2.2 3.7 7.6 1.3 13.8 23.4-25.8 39-48.2 42.1-60 2.1-12.5 2.4-24.5 1.5-36-1.3 0-2.5-.1-3.7-.2-.2 3-1.2 6.5-2.9 9.8-4.2 8.3-11.3 13-15.8 10.7-4.6-2.3-5-10.8-.8-19.1.9-1.8 2-3.5 3.2-4.9-8.8-3-16.8-7.5-23.9-13.2 1.2 4-.2 10-3.9 15.6-5.1 7.7-12.8 11.6-17 8.7-4.3-2.8-3.6-11.3 1.5-19 4-4.6 8.8-9.6 14.4-9.6-2.4-2.2-4.6-4.4-6.8-6.9-12.8-14.4-22.9-32.8-32.3-52.8-2.8 3.7-6.2 5.7-9.2 4.9-3.6-1-5.7-5.8-5.6-11.8C310 167 295.5 176 281 181.9c-2.7 5.8-7.6 14.3-13.2 13.1-2.7-.8-4.6-3.6-5.3-7.6-14.9 2.9-29.5 1.3-41.6-7.5-7.1-5.1-13.6-15-14.6-29.2-2.8 4.3-6.5 6.7-9.8 5.8-5-1.3-7-9.6-4.7-18.5 2.2-7.9 7.1-13.7 11.8-13.9 2.8 0 5 2.5 5.9 4.4 1.8-5.2 4.5-10.5 8.1-16.1zm-50.1 34.1c4.9 1.4 7 9.7 4.6 18.5-2.4 8.9-8.3 15.1-13.3 13.7-5-1.3-7-9.6-4.6-18.5 2.7-6.1 6.6-14.8 13.3-13.7zm-35.4 4.3c4.9 1.4 7 9.7 4.6 18.6-2.4 8.9-8.3 15-13.3 13.6-5-1.3-7-9.6-4.6-18.5 2.8-6.2 6.6-14.6 13.3-13.7zm188.1 14c5 1.3 7 9.6 4.6 18.5-2.3 8.9-8.3 15-13.3 13.7-4.9-1.4-7.6-9.9-4.6-18.6 2.1-6.3 6.7-14.8 13.3-13.6zm-135.1 18.8c5 1.4 7.1 9.7 4.7 18.6-2.4 8.9-8.4 15-13.4 13.6-4.9-1.3-7.6-9.8-4.6-18.5 2.1-6.3 6.7-14.6 13.3-13.7zm44.3 9.4c4.9 1.3 7 9.6 4.6 18.5-2.4 8.9-8.4 15-13.3 13.7-5-1.4-7.6-9.8-4.7-18.5 2.2-6.4 6.8-14.8 13.4-13.7zm67.3 9.7c5 1.3 7.1 9.6 4.7 18.5-2.4 8.9-8.4 15.1-13.4 13.7-4.9-1.3-7-9.6-4.6-18.5 2.7-6.1 6.7-14.8 13.3-13.7zm39.4 1.8c5 1.3 7 9.6 4.6 18.5-2.4 8.9-8.3 15-13.3 13.7-4.9-1.3-7-9.6-4.6-18.5 2.7-6.2 6.6-14.8 13.3-13.7zm-197.7 3c5 1.3 7.1 9.6 4.7 18.5-2.4 8.9-8.4 15-13.3 13.7-5-1.4-7.1-9.6-4.7-18.5 2.6-6 6.8-14.9 13.3-13.7zm121.2 18.8c5 1.4 7.1 9.7 4.7 18.6-2.4 8.9-8.4 15-13.4 13.7-4.9-1.4-7-9.7-4.6-18.6 2.7-6.1 6.7-14.6 13.3-13.7zm-157.9 14.9c4.9 1.4 7 9.7 4.6 18.6-2.4 8.9-8.35 15-13.31 13.7-4.97-1.4-7.05-9.7-4.66-18.6 2.77-6.2 6.69-14.6 13.37-13.7zm209.7 6c5 1.3 7.1 9.6 4.7 18.5-2.4 8.9-8.4 15-13.3 13.7-11.7-7.3-2.1-34.1 8.6-32.2zm-109.9 2.5c5.1.3 8.9 7.9 8.4 17.1-.4 9.2-5 16.5-10.1 16.2-5.2-.3-8.9-7.9-8.4-17.1.4-9.2 5-16.5 10.1-16.2zM157.4 261c5 1.4 7.1 9.7 4.7 18.6-2.4 8.9-8.4 15-13.3 13.7-5-1.4-7.1-9.7-4.7-18.6 2.7-6.1 6.7-14.6 13.3-13.7zm199 7.9c4.3 2.8 3.6 11.3-1.5 19-5.1 7.7-12.7 11.6-17 8.7-4.3-2.9-3.6-11.4 1.5-19 3.7-4.2 11.3-13 17-8.7zm47.1 6.5c4.4 2.7 4.1 11.2-.7 19.1-4.8 7.8-12.3 12-16.7 9.4-4.4-2.7-4-11.3.8-19.1 3.8-4.4 10.4-13.2 16.6-9.4zm-161.1 4.5c4.9 1.3 7 9.6 4.6 18.5-2.4 8.9-8.3 15-13.3 13.7-4.9-1.3-7-9.6-4.6-18.5 2.7-6.1 6.7-14.8 13.3-13.7zm50.4 10.8c4.3 2.8 3.6 11.3-1.5 19-5.1 7.7-12.7 11.6-17 8.7-4.3-2.9-3.6-11.4 1.5-19 3.7-4.1 11.3-13 17-8.7zM107 300.2c4.9 1.4 7 9.7 4.6 18.6-2.4 8.9-8.3 15-13.33 13.6-4.96-1.3-7.04-9.6-4.65-18.5 2.77-6.2 6.68-14.6 13.38-13.7zm222.5 10.3c4.3 2.9 3.6 11.4-1.5 19.1-5.1 7.6-12.7 11.5-17 8.7-4.3-2.9-3.6-11.4 1.5-19.1 3.9-4.4 11-12.6 17-8.7zm-133 .3c5 1.3 7.1 9.6 4.7 18.5-2.4 8.9-8.4 15-13.3 13.7-5-1.4-7.1-9.6-4.7-18.5 2.6-6 6.8-14.9 13.3-13.7zm-52.5 5.9c5 1.3 7.1 9.6 4.7 18.5-2.4 8.9-8.4 15-13.4 13.7-4.9-1.3-7.5-9.8-4.6-18.5 2.1-6.2 6.8-14.9 13.3-13.7zm121.1 17.5c4.3 2.8 3.6 11.4-1.5 19-5.1 7.7-12.7 11.6-17 8.7-4.3-2.8-3.6-11.4 1.5-19 3.7-4.2 11.3-13 17-8.7zm30.2 22.5c4.3 2.9 3.6 11.4-1.5 19-5.1 7.7-12.7 11.6-17 8.7-4.3-2.8-3.6-11.3 1.5-19 4-4.3 11-12.6 17-8.7zm40.3 1.5c4.2 2.9 3.5 11.4-1.6 19-5.1 7.7-12.7 11.6-17 8.7-4.2-2.8-3.6-11.3 1.6-19 4.1-4.6 10.8-12.3 17-8.7zm-132.1-.4c4.9 1.4 7 9.7 4.6 18.6-2.4 8.9-8.3 15-13.3 13.7-5-1.4-7.6-9.9-4.6-18.6 2.3-6.8 6.4-14.3 13.3-13.7zm-94.9 12.6c5 1.3 7.1 9.6 4.7 18.5-2.4 8.9-8.4 15-13.36 13.7-4.97-1.4-7.05-9.7-4.65-18.5 2.62-6 6.81-14.9 13.31-13.7zm47.7 10.4c4.9 1.3 7 9.6 4.6 18.5-2.4 8.9-8.3 15-13.3 13.7-5-1.3-7.7-9.8-4.7-18.5 2.2-6.3 6.8-14.8 13.4-13.7zm76.7 20.1c4.3 2.9 3.6 11.4-1.5 19.1-5.1 7.6-12.7 11.5-17 8.7-4.3-2.9-3.6-11.4 1.5-19.1 3.9-4.4 11-12.6 17-8.7zm41.1 6.5c4.3 2.9 3.6 11.4-1.5 19.1-5.1 7.6-12.7 11.5-17 8.7-4.3-2.9-3.6-11.4 1.5-19.1 3.9-4.3 11-12.6 17-8.7zm-152.6 26.5c5 1.4 7.1 9.7 4.7 18.6-2.4 8.9-8.4 15-13.3 13.6-5-1.3-7.1-9.6-4.7-18.5 2.7-6.1 6.8-14.6 13.3-13.7zm64.3 10.5c4.2 2.9 3.5 11.4-1.6 19.1-5.1 7.6-12.7 11.5-17 8.7-4.3-2.9-3.6-11.4 1.5-19.1 4.1-4.6 10.9-12.3 17.1-8.7z', // GiStrawberry icon
  'tradingPost': 'M264.4 95.01c-35.6-.06-80.2 11.19-124.2 34.09C96.27 152 61.45 182 41.01 211.3c-20.45 29.2-25.98 56.4-15.92 75.8 10.07 19.3 35.53 30.4 71.22 30.4 35.69.1 80.29-11.2 124.19-34 44-22.9 78.8-53 99.2-82.2 20.5-29.2 25.9-56.4 15.9-75.8-10.1-19.3-35.5-30.49-71.2-30.49zm91.9 70.29c-3.5 15.3-11.1 31-21.8 46.3-22.6 32.3-59.5 63.8-105.7 87.8-46.2 24.1-93.1 36.2-132.5 36.2-18.6 0-35.84-2.8-50.37-8.7l10.59 20.4c10.08 19.4 35.47 30.5 71.18 30.5 35.7 0 80.3-11.2 124.2-34.1 44-22.8 78.8-52.9 99.2-82.2 20.4-29.2 26-56.4 15.9-75.7zm28.8 16.8c11.2 26.7 2.2 59.2-19.2 89.7-18.9 27.1-47.8 53.4-83.6 75.4 11.1 1.2 22.7 1.8 34.5 1.8 49.5 0 94.3-10.6 125.9-27.1 31.7-16.5 49.1-38.1 49.1-59.9 0-21.8-17.4-43.4-49.1-59.9-16.1-8.4-35.7-15.3-57.6-20zm106.7 124.8c-10.2 11.9-24.2 22.4-40.7 31-35 18.2-82.2 29.1-134.3 29.1-21.2 0-41.6-1.8-60.7-5.2-23.2 11.7-46.5 20.4-68.9 26.1 1.2.7 2.4 1.3 3.7 2 31.6 16.5 76.4 27.1 125.9 27.1s94.3-10.6 125.9-27.1c31.7-16.5 49.1-38.1 49.1-59.9z', // GiTwoCoins icon
  'haven': 'M137 41v16.828c84.313 17.835 157.15 13.99 238 .348V41zm128 105.512c19.367-2.58 41.85-11.815 64.47-20.95 22.046-8.905 44.324-19.27 65.885-18.144 10.81.564 22.064 5.04 30.637 10.24 28.702 17.556 41.142 56.438 22.207 86.21-14.93 23.473-47.34 33.593-71.794 17.155-18.602-12.504-26.55-39.04-12.386-58.642 10.274-14.217 31.507-20.235 46.64-8.017 5.145 4.154 8.53 9.938 9.652 16.432 1.122 6.494-.45 14.17-5.81 19.734-3.35 3.476-7.535 5.53-12.44 6.01-4.904.478-11.24-1.43-14.904-6.47 4.576-2.843 16.11-12.02 15.426-16.203-.334-1.935-1.69-4.25-3.223-5.486-6.104-4.928-15.96-2.098-20.764 4.552-7.58 10.49-2.957 25.878 7.843 33.138 15.324 10.302 36.736 3.615 46.583-11.87 13.114-20.618 4.17-48.587-16.414-61.177-7.815-4.78-16.398-7.617-25.006-7.35-8.258.254-17.547 2.213-26.84 6.013-10.4 4.252-18.874 12.83-24.805 22.86-19.115 32.318-5.055 74.713 26.97 93.2 38.652 22.313 88.847 5.406 110.478-32.932 25.616-45.4 5.766-103.877-39.133-128.802-17.23-9.623-30.26-13.436-49.216-11.737-37.342 3.348-69.34 13.7-124.06 14.55l-18-.01c-54.814-.904-84.714-10.723-124.016-14.764-17.376-1.786-35.734 4.564-49.26 11.962-44.898 24.925-64.748 83.402-39.132 128.802 21.63 38.338 71.826 55.245 110.478 32.932 32.025-18.487 46.085-60.882 26.97-93.2-5.93-10.03-14.404-18.608-24.804-22.86-9.293-3.8-18.582-5.76-26.84-6.014-8.608-.266-17.19 2.572-25.005 7.35-20.583 12.59-29.527 40.56-16.413 61.18 9.847 15.483 31.26 22.17 46.584 11.868 10.8-7.26 15.425-22.647 7.844-33.138-4.804-6.65-14.66-9.48-20.765-4.55-1.533 1.235-2.89 3.55-3.224 5.485-.082 6.955 9.04 11.55 15.426 16.203-3.664 5.04-10 6.948-14.904 6.47-4.905-.48-9.09-2.534-12.44-6.01-5.36-5.564-6.932-13.24-5.81-19.735 1.12-6.494 4.507-12.278 9.652-16.432 15.133-12.218 36.366-6.2 46.64 8.018 14.164 19.602 6.216 46.14-12.386 58.643C111.14 237.46 78.73 227.34 63.8 203.867c-18.934-29.77-6.494-68.653 22.208-86.21 9.37-6.07 19.283-9.443 30.637-10.24 21.537-1.51 43.84 9.24 65.884 18.144 22.62 9.137 45.103 18.372 64.47 20.952zm-76.287.98c9.008 16.32 11.675 34.306 9.12 51.508h116.335c-2.556-17.202.11-35.19 9.12-51.508-19.145 7.748-38.797 15.19-58.288 17.217h-18c-19.49-2.03-39.144-9.47-58.287-17.218zM193.135 217c-3.398 9.055-8.266 17.59-14.416 25.193l13.05 40.493L211.84 217zm43.025 0L256 281.934 275.84 217zm64 0L320 281.934l12.45-40.752c-5.765-7.344-10.34-15.53-13.585-24.182zM224 238.8L201.94 311h44.12zm64 0L265.94 311h44.12zm58.826 16.934L329.94 311h37.007l-1.91-43.963c-2.393-1.12-4.762-2.34-7.098-3.687-3.927-2.267-7.635-4.82-11.114-7.616zm-182.45.635c-3.247 2.546-6.688 4.886-10.315 6.98-2.335 1.348-4.704 2.566-7.097 3.687L145.053 311h36.93zM144.27 329l-6.87 158h21.846l3.758-135.25 17.992.5L177.254 487h25.87L205 351.875l18 .25L221.127 487H247V352h18v135h25.873L289 352.125l18-.25L308.877 487h25.87l-3.743-134.75 17.992-.5L352.754 487H374.6l-6.87-158z', // GiIonicColumn
};
const terrainColorMap: Record<string, string> = {
  'grass': 'lightgreen',
  'water': 'blue',
  'mountain': 'grey',
  'forest': 'darkgreen',
  'sand': '#C2B280',
  'snow': 'white',
  'ice': 'lightblue',
};

export function gridToCartesian ({x, y}: Coordinate) {
  return {
    x: x * Math.sqrt(3) +
       y * Math.sqrt(3) / 2,
    y: y * 3/2,
  };
}

export class CanvasRenderer {
  canvas: HTMLCanvasElement;
  ctx: CanvasRenderingContext2D;
  ghost: Coordinate[];
  ghostColor?: string;
  scale: number;
  events: { [event: string]: any[] };

  constructor (canvas: HTMLCanvasElement, scale: number) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d')!;
    this.scale = scale;
    this.events = { click: [], mousemove: []};
    this.ghost = [];
    
    this.canvas.addEventListener('click', (e) => {
      this.events['click'].forEach((cb) => cb(this.eventToTarget(e)));
    });
    
    this.canvas.addEventListener('mousemove', (e) => {
      this.events['mousemove'].forEach((cb) => cb(this.eventToTarget(e)));
    });
  }
  
  eventToTarget (e: MouseEvent) {
    const latticeCoordinates = this.canvasToGrid({
      x: e.offsetX,
      y: e.offsetY
    });
    
    const candidates = [
      { x: Math.ceil(latticeCoordinates.x), y: Math.ceil(latticeCoordinates.y) },
      { x: Math.floor(latticeCoordinates.x), y: Math.ceil(latticeCoordinates.y) },
      { x: Math.ceil(latticeCoordinates.x), y: Math.floor(latticeCoordinates.y) },
      { x: Math.floor(latticeCoordinates.x), y: Math.floor(latticeCoordinates.y) }
    ];
      
    function cartesianDistance({x, y}: Coordinate) {
      return Math.pow(x - e.offsetX, 2) +
             Math.pow(y - e.offsetY, 2);
    }
    
    const scores = candidates.map(
      (c) => cartesianDistance(this.gridToCanvas(c))
    );
    
    return candidates[scores.indexOf(Math.min(...scores))];
  }
  
  on (event: string, cb: any) {
    this.events[event].push(cb);
  }
  
  setGhost (coords: Coordinate[]) {
    this.ghost = coords;
  }

  cartesianToCanvas ({x, y}: Coordinate) {
    return {
      x: x + this.canvas.width / 2,
      y: y + this.canvas.height / 2,
    }
  }
  
  canvasToCartesian ({x, y}: Coordinate) {
    return {
      x: x - this.canvas.width / 2,
      y: y - this.canvas.height / 2,
    }
  }
  
  gridToCartesian ({x, y}: Coordinate, scale = this.scale) {
    return {
      x: x * Math.sqrt(3) * scale +
         y * scale * Math.sqrt(3)/ 2,
      y: y * 3/2 * scale,
    };
  }
  
  cartesianToGrid ({x, y}: Coordinate, scale = this.scale) {
    return {
      x: (x / (scale * Math.sqrt(3))) -
         (y / (scale * 3)),
      y: (y * 2/3) / scale,
    };
  }
  
  canvasToGrid (p: Coordinate) {
    return this.cartesianToGrid(this.canvasToCartesian(p));
  }
  
  gridToCanvas (p: Coordinate) {
      return this.cartesianToCanvas(this.gridToCartesian(p));
  }
  
  drawHex (center: Coordinate, scale: number, fill: string, stroke: string | null = 'black', icon: string | null = null) {
    // Draw a hex
    this.ctx.beginPath();
    this.ctx.moveTo(
      center.x,
      center.y + scale,
    );
    for (let i = 1; i < 6; i++) {
      this.ctx.lineTo(
        center.x + scale * Math.sin(i * Math.PI / 3),
        center.y + scale * Math.cos(i * Math.PI / 3),
      );
    }
    this.ctx.lineTo(
      center.x,
      center.y + scale,
    );
    this.ctx.fillStyle = fill;
    if (stroke) {
      this.ctx.strokeStyle = stroke;
      this.ctx.stroke();
    }
    this.ctx.fill();
    if (icon) {
      const path = new Path2D(icon);
      this.ctx.save();
      this.ctx.translate(center.x - this.scale * 2 / 3, center.y - this.scale * 2 / 3);
      this.ctx.scale(0.05, 0.05);
      this.ctx.fillStyle = (fill === 'gray' ? 'black' : 'gray');
      this.ctx.fill(path);
      this.ctx.restore();
    }
  }
  
  sum ({x: x1, y: y1}: Coordinate, {x: x2, y: y2}: Coordinate) {
    return {x: x1 + x2, y: y1 + y2};
  }
  equal ({x: x1, y: y1}: Coordinate, {x: x2, y: y2}: Coordinate) {
    return x1 === x2 && y1 === y2;
  }

  drawBar (center: Coordinate, scale: number, current: number, max: number) {
    this.ctx.fillStyle = 'red';
    this.ctx.fillRect(
      center.x - scale / 2,
      center.y - scale / 20,
      scale,
      scale / 10
    );
    this.ctx.fillStyle = 'green';
    this.ctx.fillRect(
      center.x - scale / 2,
      center.y - scale / 20,
      scale * current / max,
      scale / 10
    );
  }

  renderBoard (board: Board,
      scale = this.scale,
      offset = { x: this.canvas.width / 2, y: this.canvas.height / 2},
      stroke = 'black') {
    offset = offset ||
      {
        x: this.canvas.width / 2,
        y : this.canvas.height / 2
      };
    scale = scale || this.scale;
    
    board.allCells.forEach((cell: Cell) => {
      this.drawHex(
        this.sum(
          offset,
          this.gridToCartesian(cell.position, scale)
        ),
        scale,
        cell.buildingTexture ? buildingColorMap[cell.buildingTexture] : terrainColorMap[cell.terrain],
        stroke,
        cell.building ? buildingIconMap[cell.building.kind] : null,
      );
      if (cell.building && this.equal(cell.position, cell.building!.position!) && cell.building.progress < cell.building.maxProgress) {
        this.drawBar(
          this.sum(
            offset,
            this.gridToCartesian(cell.position, scale)
          ),
          scale,
          cell.building.progress,
          cell.building.maxProgress
        );
      }
    });
  }

  renderGlobe (globe: Globe,
      board: Board,
      scale = this.scale,
      offset = { x: this.canvas.width / 2, y: this.canvas.height / 2},
      stroke = false) {
    globe.allCells.forEach((cell: Cell) => {
      this.drawHex(
        this.sum(
          offset,
          this.gridToCartesian(plus(
            cell.position,
            globe.boardCenter(cell.board.position)
          ), scale)
        ),
        scale,
        (cell.board === board &&
        (Math.abs(cell.position.x + cell.position.y) >= cell.board.radius ||
        Math.abs(cell.position.x) >= cell.board.radius ||
        Math.abs(cell.position.y) >= cell.board.radius)) ?
        'yellow' :
        (cell.buildingTexture ? buildingColorMap[cell.buildingTexture] : terrainColorMap[cell.terrain]),
        (Math.abs(cell.position.x + cell.position.y) >= cell.board.radius ||
        Math.abs(cell.position.x) >= cell.board.radius ||
        Math.abs(cell.position.y) >= cell.board.radius) ?
        (cell.board.buildings.length > 0 ? 'yellow' : 'black')
        : null
      );

      if (cell.board.buildings.length > 0) {
        this.ctx.globalAlpha = 0.5;
        this.drawHex(
          this.sum(
            offset,
            this.gridToCartesian(plus(
              cell.position,
              globe.boardCenter(cell.board.position)
            ), scale)
          ),
          scale,
          'yellow',
          (Math.abs(cell.position.x + cell.position.y) >= cell.board.radius ||
          Math.abs(cell.position.x) >= cell.board.radius ||
          Math.abs(cell.position.y) >= cell.board.radius) ?
          (cell.board.buildings.length > 0 ? 'yellow' : 'black')
          : null
        );
        this.ctx.globalAlpha = 1;
      }
    });
  }
  
  renderGhosts () {
    if (this.ghostColor) {
      this.ghost.forEach((g) => {
        this.ctx.globalAlpha = 0.5;
        this.drawHex(
          this.gridToCanvas(g),
          this.scale,
          this.ghostColor!
        );
        this.ctx.globalAlpha = 1;
      });
    }
  }
  
  clear () {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
  }
}
